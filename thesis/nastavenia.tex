\def\mfdriver{http://www.ftdichip.com/Drivers/D2XX.htm}
\def\mfinstall{http://www.ftdichip.com/Drivers/D2XX/Linux/ReadMe-linux.txt}

\chapter{Príprava a úvodné nastavenia}

\label{kap:priprava} % id kapitoly pre prikaz ref

Táto kapitola sa priamo netýka vývoja programu, ale špecifikácie hardwaru a softwaru použitého pri
vývoji. V kapitole sú uvedené aj nastavenia potrebné pre komunikáciu so zariadením. Špecifikácia
napríklad ovplyvňuje možnosti využitia systémových volaní, preto na konci kapitoly sú uvedené aj
požiadavky potrebné na inštaláciu a spustenie programu.


\section{Hardware}
Hardwarová špecifikácia zariadenia, na ktorom je program kompilovaný a spúštaný. Najdôležitejším 
parametrom je  procesor, jeho architektúra a inštrukčná sada, keďže priamo ovlyvňuje kompiláciu.
\begin{itemize}
\item  Názov: Raspebrry Pi 2 model B
\item  Procesor: Cortex A7 900MHz
\item  Architektúra: ARMv7-A
\item  Grafický čip: Broadcom Videocore IV 250MHz
\item  Operačná pameť: 1GB
\end{itemize}


\section{Operačný systém}
Operačný systém a verzia jadra systému hovoria, ktoré systémové volania a prepínače môžu byť použité. 
Aj keď Linux-ové a Unix-ové systémy podporujú štandarty POSIX, existuje niekoľko rozdielov, ktorým bude
vhodné sa pri vývoji vyhnúť.
\begin{itemize}
\item OS: GNU/Linux
\item Distribúcia : Arch
\item Veria jadra: 4.0.7
\end{itemize}


\section{FTDI knižnica funkcií pre zariadenia typu D2XX }
Pre ovládanie zariadenia je potrebné doplniť systém o knižnicu príkazov narábajúcich s chipom v zariadení. 
Zariadenie obsahuje chip vyrábaný firmou Future Technology Devices International, ktorá poskytuje ovládače 
a programátorský manuál pre volania funkcií. 

\subsection{Inštalácia}
Všetky potrebné súbory sa dajú stiahnuť na adrese: \newline
 \mfdriver \newline
Je potrebné vedieť architektúru operačného systému. Pri 32-bitových a 64-bitových operačných systémoch existuje
len jedna možnosť, avšak pri architektúre ARM sú štyri, v závisloti od verzie architektúry a reprezentácie floating point 
(reálne čísla). Bežný uživateľ nemusí mať v týchto veciach prehľad a preto je vhodné vytvoriť spusiteľný skript, 
ktorý z informácií získanýchzo systému zvolí vhodný ovládač a užívateľa len informuje, poprípade mu dá možnosť 
voľbu zmeniť. 
\\ \newline
Uvediem len stručný popis inštalácie. Obsiahlejšia verzia v angličtine: \newline
 \mfinstall \newline
Pri inštalácií sú potrebné prístupové práva používateľa root!
\begin{enumerate}
\item tar xfvz libftd2xx-<architektúra>-1.3.6.tgz \newline
	Rozbalenie archívu do aktuálnej zložky.
\item su root \newline
	Prihlásiť ako používateľ root. Alternatívne môžme použiť sudo -s
\item cp build/libftd2xx.* /usr/local/lib \newline 
	Skopíruje potrebné súbory do lokálnych knižníc systému.
\item chmod 0755 /usr/local/lib/libftd2xx.so.1.3.6\newline 
	Zmení prístupové práva tak, aby aby aj ostatní používatelia môhli k súboru pristupovať, ale bez možnosti zápisu.
\item ln -sf /usr/local/lib/libftd2xx.so.1.3.6 /usr/local/lib/libftd2xx.so\newline 
	Vytvorenie symbolického linku ku knižnici.
\item exit \newline 
	Odhlásenie z používateľa root.
\end{enumerate}

\subsection{Test funkčnosti}
Pre test funkčnosti stačí skompilovať niektorý z príkladov. Po rozbalení archívu sa nachádzajú v zložke examples.
Dobrým príkladom je čítanie z EEPROM. Makefile a zdrojový kód sú poskytnuté. Ak skompilovaný program po spustení zlyhá 
a zahlási chybu pri otvorení portu najprv treba skontrolovať aktívne moduly systému. Pomocou príkazu lsmod získame
aktuálne aktívne moduly. Ak sa medzi nimi nachádzajú moduly s názvami ftdi\textunderscore sio a usbserial, tak ich treba aj napriek 
intuícií vypnúť príkazom rmmod pri každom pripojení zariadenia alebo moduly úplne zakázať, čo ale môže spôsobiť problémy
s inými zariadeniami. Príkaz rmmod vyžaduje prístupové práva používateľa root, preto je vhodné vytvoriť spustiteľný skript,
ktorý bude mať zvýšené práva a moduly odstráni. Ak problém stále pretrváva, program nerozozná zariadanie a treba upraviť
zdrojový kód o inštrukciu FT\textunderscore SetVIDPID s príslušnými parametrami. V našom prípade je VID = 0x0403 a PID = 0xFAF0. 
TODO kde vytiahnut vid pid pre rozne distribucie, automatizovat v programe


\subsection{Prehľad funkcií}
V tejto časti sú uvedené knižničné funkcie špecifické pre komunikáciu s chipom, ktoré su v programe využité. 
TODO - opisat WORD, doubleWORD...? ,  pridat pouzite funkcie a vymazat nepouzite \newline

\textbf{\large FT\textunderscore SetVIDPID}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore SetVIDPID ( unsigned int VID, unsigned int PID )
  \item[Popis] 	\hfill \\ Pridá kombináciu identifikátorov do tabuľky zariadení. Potrebné pre nahratie správneho ovládača do systému.
  \item[Parametre]  \hfill \\ VID - identifikátor výrobcu zariadenia \newline PID - identifikátor produktu zariadenia 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore CreateDeviceInfoList}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore CreateDeviceInfoList ( unsigned int* NumDevs )
  \item[Popis] 	\hfill \\ Vytvorí zoznam zariadení typu D2XX a do smerníka v uloží počet zariadení pripojených do systému. Následne je možné
				alokovať potrebný priestor pre získanie kompletných informácií o zariadeniach.				
  \item[Parametre]  \hfill \\ NumDevs - smerník na premmenú do ktorej bude uložený počet zariadení
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore GetDeviceInfoList}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore GetDeviceInfoList ( FT\textunderscore DEVICE\textunderscore LIST\textunderscore INFO\textunderscore NODE *pdest, unsigned int* NumDevs )
  \item[Popis] 	\hfill \\ Uloží zoznam informácií o zariadeniach do poskytnutého pola, ktoré musí mať alokovanú dostatočnú veľkosť.
  \item[Parametre]  \hfill \\ *pdest - smerník na pole  pre uloženie zoznamu \newline
				NumDevs - smerník na počet zariadení
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description}
\hfill \break

\textbf{\large FT\textunderscore GetDeviceInfoDetail}
\begin{description} \itemsep0pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore GetDeviceInfoDetail( unsigned int Index,  unsigned int* Flags, unsigned int* Type,  unsigned int* ID, unsigned int* LocID, 
				char* SerialNumber, char* Description, FT\textunderscore HANDLE *handle )
  \item[Popis] 	\hfill \\ Z listu informácií o zariadeniach vyberie určené a informácie uloží do poskytnutých premenných.
  \item[Parametre]  \hfill \\ Index - index na vybratie zariadenia \newline
				Flags - smerník pre uloženie informácie \newline
				Type - smerník pre uloženie typu zariadenia \newline
				ID - smerník pre uloženie identifikátoru zariadenia \newline
				LocID - smerník pre uloženie lokácie, v Linuxe nepodporované \newline
				SerialNumber - smerník na začiatok pola znakov pre uloženie sériového čísla, ukončené ako bežný cstring \newline
				Description - smerník na začiatok pola znakov pre uloženie popisu, ukončené ako bežný cstring \newline
				*ft\textunderscore handle - smerník na uloženie handle pre ďalšie narábanie so zariadením
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore Open}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore SetVIDPID ( int iDevice, FT\textunderscore HANDLE *handle )
  \item[Popis] 	\hfill \\ Pripojí zariadenie a uloží handle.
  \item[Parametre]  \hfill \\ iDevice - index zariadenia \newline *handle  - smerník na uloženie handle 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore OpenEx}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore OPenEx ( void* arg1, unsigned int Flags, FT\textunderscore HANDLE *handle )
  \item[Popis] 	\hfill \\ Pripojí bližšie špecifikované zariadenie a uloží handle. Špecifikovať zariadenie možno cez sériové číslo alebo deskriptor.
  \item[Parametre]  \hfill \\ arg1 - smerník na argument určujúci zariadenie  \newline Flags - určuje typ poskytnutého argumentu   \newline *handle - smerník na uloženie handle 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break


\textbf{\large FT\textunderscore Close}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore Close ( FT\textunderscore HANDLE handle)
  \item[Popis] 	\hfill \\ Odpojí zariadenie.
  \item[Parametre]  \hfill \\ handle - handle zariadenia na odpojenie
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore Read}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore Read ( FT\textunderscore HANDLE handle, void* buffer, unsigned int BytesToWrite, unsigned int* BytesWritten )
  \item[Popis] 	\hfill \\ Prečíta dáta poslané zariadením. Čítanie dát sa ukončí, keď sa dosiahne BytesToRead alebo vyprší čas nastavený funkciou TODO(link) FT\textunderscore SetTimeout. 
				Pri vypršaní času sa uložia aj čiastočné dáta a funkcia vráti FT\textunderscore OK.
  \item[Parametre]  \hfill \\ handle - handle zariadenia \newline 
				buffer - smerník na buffer pre dáta \newline 
				BytesToRead - počet bajtov na prečítanie \newline 
				BytesReturned - smerník na počet prečítaných bajtov 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore Write}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore Write ( FT\textunderscore HANDLE handle, void* buffer, unsigned int BytesToRead, unsigned int* BytesReturned)
  \item[Popis] 	\hfill \\ Pošle dáta zariadeniu.
  \item[Parametre]  \hfill \\ handle - handle zariadenia \newline 
				buffer - smerník na buffer pre zapisované dáta \newline 
				BytesToWrite - počet bajtov na zapísanie \newline 
				BytesReturned - smerník na počet zapísaných bajtov 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break


\textbf{\large FT\textunderscore SetBaudRate}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore SetBaudRate ( FT\textunderscore HANDLE handle, unsigned int BaudRate)
  \item[Popis] 	\hfill \\ Nastaví rýchlosť komunikácie pripojeného zariadenia.
  \item[Parametre]  \hfill \\ handle - handle zariadenia \newline 
				BaudRate - rýchlosť v počte bitov za sekundu
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore SetDataCharacteristics}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore Write ( FT\textunderscore HANDLE handle, unsigned char WordLength, unsigned char StopBits, unsigned char Parity)
  \item[Popis] 	\hfill \\ Nastaví formu dát pre komunikáciu.
  \item[Parametre]  \hfill \\ handle - handle zariadenia \newline 
				WordLength - počet bitov v slove, možné nastavenia sú 7 alebo 8 \newline 
				StopBits - počet stop bitov, možné nastavenia sú 1 alebo 2 \newline 
				Parity - nastavenie pre kontrolný bit
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore SetTimeouts}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore SetTimeouts ( FT\textunderscore HANDLE handle, unsigned int ReadTimeout, unsigned int WriteTimeout )
  \item[Popis] 	\hfill \\ Nastaví čas, ktorý sa má čakať pri zápise a čítaní dát, ak sa nedosiahne požadovaný počet.
  \item[Parametre]  \hfill \\ handle - handle zariadenia \newline 
				ReadTimeout - čas v milisekundách \newline 
				WriteTimeout - čas v milisekundách 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break


\textbf{\large FT\textunderscore Purge}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore Purge ( FT\textunderscore HANDLE handle)
  \item[Popis] 	\hfill \\ Vymaže dáta pre čítania a výpis v zariadení.
  \item[Parametre]  \hfill \\ handle - handle zariadenia \newline 
				mask - kombinácia pre vstupný a výstupný buffer 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\textbf{\large FT\textunderscore ResetDevice}
\begin{description} \itemsep1pt \parskip0pt \parsep0pt
  \item[Definícia] \hfill \\	FT\textunderscore STATUS FT\textunderscore ResetDevice( FT\textunderscore HANDLE handle )
  \item[Popis] 	\hfill \\ Reštartuje zariadenie.
  \item[Parametre]  \hfill \\ handle - handle zariadenia 
  \item[Návratová hodnota] \hfill \\ FT\textunderscore OK alebo chybový kód v prípade zlyhania.
\end{description} 
\hfill \break

\section{Požiadavky}
TODO - na konci otestovat a doplnit(verzia kernelu, programy - gcc)
